{% extends "base.html" %}{% load static %}
{% block content %}

<style>
  .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem}
  .tile{padding:1rem;border-radius:10px;color:#fff;text-align:center;font-weight:bold;cursor:pointer;transition:transform .2s}
  .tile:hover{transform:scale(1.02)} .tile[data-state="ON"]{box-shadow:0 0 10px 3px rgba(255,255,255,.35)}
  .tile-code-blue{background:#dc3545}.tile-nurse{background:#0d6efd}.tile-move{background:#ffc107;color:#212529}
  .tile-light{background:#6c757d}.tile-rfid{background:#198754}.tile-env{background:#0dcaf0}
  /* Toast banner */
  #toast{position:fixed;top:1rem;right:1rem;z-index:1080}
</style>

<div class="container mt-4">
  <h3 class="mb-3">🛏️ Bedside <code>bedsidev3</code> Dashboard
      <a href="{% url 'bedside:bedside_download_csv' %}" class="btn btn-sm btn-outline-primary ms-3">
          📥 Download CSV
      </a>
  </h3>

  <!-- Tiles -->
  <div class="dashboard-grid mb-4">
    <div id="tile-code-blue"  class="tile tile-code-blue" data-state="OFF">
      <i class="bi bi-exclamation-octagon-fill fs-2 d-block mb-1"></i>Code Blue
    </div>
    <div id="tile-nurse-call" class="tile tile-nurse" data-state="OFF">
      <i class="bi bi-bell-fill fs-2 d-block mb-1"></i>Nurse Call
    </div>
    <div id="tile-no-move"    class="tile tile-move" data-state="OFF">
      <i class="bi bi-person-x-fill fs-2 d-block mb-1"></i>No Movement
    </div>
    <div id="tile-light"      class="tile tile-light" data-state="OFF">
      <i class="bi bi-lightbulb-fill fs-2 d-block mb-1"></i>Room Light
    </div>
    <div id="tile-env" class="tile tile-env">
      <i class="bi bi-thermometer-half fs-2 d-block mb-1"></i>
      <span id="temp-now">--</span> °C /
      <span id="hum-now">--</span> %
      <div class="small">
        <span id="temp-avg">--</span> °C •
        <span id="hum-avg">--</span> % (1 min avg)
      </div>
    </div>
    <div id="tile-rfid"       class="tile tile-rfid">
      <i class="bi bi-person-badge-fill fs-2 d-block mb-1"></i>RFID Tag
      <div id="rfid-val" class="fs-5 mt-1">--</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <h5 class="card-title">📈 Temperature &amp; Humidity (last 40)</h5>
      <div style="height:240px"><canvas id="tempChart" class="w-100 h-100"></canvas></div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* WebSocket helper (8000 even when page from 8001) */
const protocol = location.protocol==="https:"?"wss":"ws";
const wsPort   = location.port==="8001"?"8000":location.port;
const wsHost   = location.hostname+(wsPort?":"+wsPort:"");
const ws       = new WebSocket(`${protocol}://${wsHost}/ws/bedsidev3/dashboard/`);

/* MQTT publish helper */
function mqttPublish(topic,payload){
  fetch("{% url 'mqtt_publish' %}",{
    method:"POST",
    headers:{"Content-Type":"application/json","X-CSRFToken":"{{ csrf_token }}"},
    credentials:"same-origin",
    body:JSON.stringify({topic,payload})
  });
}
const mqttAck = t=>mqttPublish(t,"ack");

/* Tiles click */
document.getElementById("tile-code-blue" ).onclick=()=>mqttAck("bedsidev3/nursecall/code_blue/ack");
document.getElementById("tile-nurse-call").onclick=()=>mqttAck("bedsidev3/nursecall/nurse_call/ack");
document.getElementById("tile-no-move"   ).onclick=()=>mqttAck("bedsidev3/nursecall/no_movement/ack");
document.getElementById("tile-light"     ).onclick=()=>{
  const on=document.getElementById("tile-light").dataset.state!=="ON";
  mqttPublish("bedsidev3/room/light/set",on?"on":"off");
  setActive("tile-light",on); // optimistic
};

/* Temp/Hum rolling arrays for 60 s average */
const bufT=[],bufH=[],AVG_WIN_MS=60000;

/* Chart */
const chart=new Chart(document.getElementById("tempChart"),{
  type:"line",
  data:{labels:[],datasets:[
    {label:"Temp °C",yAxisID:"y",data:[],borderColor:"#0dcaf0",tension:.3},
    {label:"Humidity %",yAxisID:"y1",data:[],borderColor:"#6610f2",tension:.3}
  ]},
  options:{animation:false,scales:{y:{},y1:{position:"right",grid:{drawOnChartArea:false}}}}
});
function updateChart(i,v){
  chart.data.labels.push(new Date().toLocaleTimeString());
  chart.data.datasets[i].data.push(v);
  if(chart.data.labels.length>40){
    chart.data.labels.shift();
    chart.data.datasets.forEach(d=>d.data.shift());
  }
  chart.update();
}
/* Helpers */
function setActive(id,on){document.getElementById(id).dataset.state=on?"ON":"OFF";}
function toast(msg,cls="danger"){
  const div=document.createElement("div");
  div.className=`alert alert-${cls} shadow`;
  div.innerText=`[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById("toast").prepend(div);
  setTimeout(()=>div.remove(),8000);
}

/* WebSocket handler */
ws.onmessage=e=>{
  const {event,data}=JSON.parse(e.data);
  switch(event){
    case "code_blue":
      setActive("tile-code-blue",data.active);
      if(data.active) toast("🚨 CODE BLUE pressed");
      break;
    case "nurse_call":
      setActive("tile-nurse-call",data.active);
      if(data.active) toast("🛎️ NURSE CALL pressed","warning");
      break;
    case "no_movement": setActive("tile-no-move",data.active); break;
    case "room_light":  setActive("tile-light",data.state==="on"); break;

    case "temperature":{
      const t=parseFloat(data.value);
      document.getElementById("temp-now").innerText=t.toFixed(1);
      bufT.push([Date.now(),t]);
      updateChart(0,t);
      break;
    }
    case "humidity":{
      const h=parseFloat(data.value);
      document.getElementById("hum-now").innerText=h.toFixed(1);
      bufH.push([Date.now(),h]);
      updateChart(1,h);
      break;
    }
    case "rfid_tag": document.getElementById("rfid-val").innerText=data.uid; break;
  }
};

/* Every 5 s compute 60 s average */
setInterval(()=>{
  const cutoff=Date.now()-AVG_WIN_MS;
  const avg = arr=>{
    while(arr[0] && arr[0][0]<cutoff) arr.shift();
    const s=arr.reduce((a,b)=>a+b[1],0); return arr.length?s/arr.length:NaN;
  };
  const t=avg(bufT),h=avg(bufH);
  if(!isNaN(t)) document.getElementById("temp-avg").innerText=t.toFixed(1);
  if(!isNaN(h)) document.getElementById("hum-avg").innerText=h.toFixed(1);
},5000);
</script>
{% endblock %}
