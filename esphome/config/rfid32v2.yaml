esphome:
  name: rfid32v2
  friendly_name: rfid32v2

esp32:
  board: nodemcu-32s

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Rfid32 Fallback Hotspot"
    password: "JA3PKMmHSREP"

captive_portal:

mqtt:
  broker: !secret mqtt_broker
  port: 1883
  username: !secret mqtt_username
  password: !secret mqtt_password

  on_message:
    - topic: "nursecall/code_blue/ack"
      then:
        - lambda: |-
            id(code_blue_active) = false;
        - light.turn_off: ky016_rgb_led
        - switch.turn_off: buzzer

    - topic: "nursecall/nurse_call/toggle"
      then:
        - lambda: |-
            id(nurse_call_active) = !id(nurse_call_active);
        - if:
            condition:
              lambda: 'return id(nurse_call_active) && !id(code_blue_active);'
            then:
              - light.turn_on:
                  id: ky016_rgb_led
                  red: 100%
                  green: 0%
                  blue: 0%
              - switch.turn_on: buzzer
              - delay: 200ms
              - switch.turn_off: buzzer
        - if:
            condition:
              lambda: 'return !id(nurse_call_active) && !id(code_blue_active);'
            then:
              - light.turn_off: ky016_rgb_led

# --- GLOBALS ---
globals:
  - id: code_blue_active
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: nurse_call_active
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: nurse_call_timestamp
    type: unsigned long
    restore_value: no
    initial_value: '0'

  - id: no_movement_alert
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: no_movement_sent
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: last_motion
    type: unsigned long
    restore_value: no
    initial_value: '0'

  - id: last_rfid_uid
    type: std::string
    restore_value: no
    initial_value: '"No tag"'

# --- OUTPUTS ---
output:
  - platform: ledc
    pin: GPIO5
    id: red_pwm
  - platform: ledc
    pin: GPIO16
    id: green_pwm
  - platform: ledc
    pin: GPIO27
    id: blue_pwm

# --- RGB Light ---
light:
  - platform: rgb
    name: "KY016 RGB LED"
    id: ky016_rgb_led
    red: red_pwm
    green: green_pwm
    blue: blue_pwm
    restore_mode: ALWAYS_OFF

# --- Buzzer Switch ---
switch:
  - platform: gpio
    pin: GPIO32
    name: "Buzzer"
    id: buzzer
    restore_mode: ALWAYS_OFF
    on_turn_on:
      then:
        - mqtt.publish:
            topic: "nursecall/buzzer"
            payload: "on"
    on_turn_off:
      then:
        - mqtt.publish:
            topic: "nursecall/buzzer"
            payload: "off"

  - platform: template
    name: "Buzzer via MQTT"
    id: buzzer_control
    optimistic: true
    turn_on_action:
      - switch.turn_on: buzzer
    turn_off_action:
      - switch.turn_off: buzzer

# --- Binary Sensors ---
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO12
      mode: INPUT_PULLUP
      inverted: true
    name: "Nurse Call Button"
    on_press:
      then:
        - lambda: |-
            id(nurse_call_active) = true;
            id(nurse_call_timestamp) = millis();
        - if:
            condition:
              lambda: 'return !id(code_blue_active);'
            then:
              - light.turn_on:
                  id: ky016_rgb_led
                  red: 100%
                  green: 0%
                  blue: 0%
              - mqtt.publish:
                  topic: "nursecall/nurse_call"
                  payload: "pressed"
    on_release:
      then:
        - lambda: |-
            id(nurse_call_active) = false;

  - platform: gpio
    pin: 
      number: GPIO13
      mode: INPUT_PULLUP
      inverted: True
    name: "Code Blue Button"
    on_press:
      then:
        - lambda: |-
            id(code_blue_active) = true;
        - light.turn_on:
            id: ky016_rgb_led
            red: 0%
            green: 0%
            blue: 100%
        - mqtt.publish:
            topic: "nursecall/code_blue"
            payload: "pressed"
    on_release:
      then:
        - logger.log: "Code Blue remains active until acknowledged via MQTT"

  - platform: gpio
    pin: GPIO14
    name: "PIR Motion Sensor"
    on_press:
      then:
        - lambda: |-
            id(last_motion) = millis();
        - mqtt.publish:
            topic: "nursecall/movement"
            payload: "detected"
        - lambda: |-
            if (!id(code_blue_active) && !id(nurse_call_active)) {
              auto call = id(ky016_rgb_led).turn_on();
              call.set_red(0.0f);
              call.set_green(1.0f);
              call.set_blue(0.0f);
              call.perform();
            }

# --- Sensors ---
sensor:
  - platform: dht
    pin: GPIO15
    model: RHT03
    temperature:
      name: "Room Temperature"
      id: room_temp
      unit_of_measurement: "°C"
      accuracy_decimals: 1
      on_value:
        then:
          - mqtt.publish:
              topic: nursecall/temperature
              payload: !lambda 'return str_sprintf("%.1f °C", x);'
    humidity:
      name: "Room Humidity"
      id: room_humidity
      unit_of_measurement: "%"
      accuracy_decimals: 1
      on_value:
        then:
          - mqtt.publish:
              topic: nursecall/humidity
              payload: !lambda 'return str_sprintf("%.1f %%", x);'

  - platform: adc
    pin: GPIO34
    name: "Sound Sensor"
    update_interval: 1s
    filters:
      - calibrate_linear:
          - 0.0 -> 0.0
          - 1023.0 -> 5.0
    on_value_range:
      - below: 1.0
        then:
          - mqtt.publish:
              topic: "nursecall/fall"
              payload: "detected"
      - above: 2.0
        then:
          - mqtt.publish:
              topic: "nursecall/loud_sound"
              payload: "detected"

# --- RFID ---
spi:
  clk_pin: GPIO18  
  mosi_pin: GPIO23
  miso_pin: GPIO19
  id: bus_spi

rc522_spi:
  id: nfc_reader
  cs_pin: GPIO21
  update_interval: 1s
  on_tag:
    then:
      - lambda: |-
          id(last_rfid_uid) = x;
      - text_sensor.template.publish:
          id: last_rfid_sensor
          state: !lambda 'return x;'
      - mqtt.publish:
          topic: rfid/tag
          payload: !lambda 'return x;'
      - logger.log:
          format: "Tag detected: %s"
          args: [ 'x.c_str()' ]

text_sensor:
  - platform: template
    name: "Last RFID Tag"
    id: last_rfid_sensor
    lambda: |-
      return id(last_rfid_uid);

# --- Interval Logic ---
interval:
  - interval: 500ms
    then:
      - if:
          condition:
            lambda: 'return id(code_blue_active);'
          then:
            - light.toggle:
                id: ky016_rgb_led
                transition_length: 0ms

  - interval: 300ms
    then:
      - if:
          condition:
            lambda: 'return id(code_blue_active);'
          then:
            - switch.toggle: buzzer

  - interval: 100ms
    then:
      - if:
          condition:
            lambda: 'return id(nurse_call_active) && !id(code_blue_active);'
          then:
            - switch.turn_on: buzzer
            - delay: 200ms
            - switch.turn_off: buzzer

  - interval: 500ms
    then:
      - lambda: |-
          unsigned long now = millis();
          if (!id(code_blue_active)) {
            if (!id(nurse_call_active) && (now - id(nurse_call_timestamp) > 5000)) {
              id(ky016_rgb_led).turn_off();
            }
          }

  - interval: 1s
    then:
      - lambda: |-
          unsigned long now = millis();
          if (!id(code_blue_active) && !id(nurse_call_active)) {
            if ((now - id(last_motion)) > 5000) {
              if (!id(no_movement_alert)) {
                id(no_movement_alert) = true;
                id(no_movement_sent) = false;
              }
              if (!id(no_movement_sent)) {
                id(buzzer).turn_on();
                delay(1000);
                id(buzzer).turn_off();
                id(no_movement_sent) = true;
                mqtt::global_mqtt_client->publish("nursecall/no_movement", "true");
              }
            } else {
              id(no_movement_alert) = false;
              id(no_movement_sent) = false;
            }
          }